<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 600" font-family="'Segoe UI', system-ui, -apple-system, sans-serif">
  <defs>
    <linearGradient id="kbg" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#0d1117"/><stop offset="100%" stop-color="#161b22"/>
    </linearGradient>
    <filter id="ks">
      <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.3"/>
    </filter>
  </defs>

  <rect width="900" height="600" fill="url(#kbg)"/>
  <text x="450" y="30" text-anchor="middle" fill="#e6edf3" font-size="18" font-weight="700">Convolution — How Kernels Transform Pixels</text>

  <!-- === How Convolution Works === -->
  <g transform="translate(30, 55)">
    <rect width="540" height="250" rx="8" fill="#1a1a2e" filter="url(#ks)" stroke="#30363d" stroke-width="1"/>
    <text x="270" y="22" text-anchor="middle" fill="#a78bfa" font-size="13" font-weight="700">3×3 Kernel Application (8bipp example)</text>

    <!-- Source pixel grid -->
    <g transform="translate(30, 45)">
      <text x="60" y="-5" text-anchor="middle" fill="#8b949e" font-size="9">Source Neighborhood</text>
      <rect x="0" y="0" width="40" height="40" fill="#1c2333" stroke="#30363d" stroke-width="0.5"/><text x="20" y="25" text-anchor="middle" fill="#6b7280" font-size="11">50</text>
      <rect x="40" y="0" width="40" height="40" fill="#1c2333" stroke="#30363d" stroke-width="0.5"/><text x="60" y="25" text-anchor="middle" fill="#6b7280" font-size="11">80</text>
      <rect x="80" y="0" width="40" height="40" fill="#1c2333" stroke="#30363d" stroke-width="0.5"/><text x="100" y="25" text-anchor="middle" fill="#6b7280" font-size="11">60</text>
      <rect x="0" y="40" width="40" height="40" fill="#1c2333" stroke="#30363d" stroke-width="0.5"/><text x="20" y="65" text-anchor="middle" fill="#6b7280" font-size="11">90</text>
      <rect x="40" y="40" width="40" height="40" fill="#a78bfa" fill-opacity="0.3" stroke="#a78bfa" stroke-width="1.5"/><text x="60" y="65" text-anchor="middle" fill="#e2e8f0" font-size="11" font-weight="700">120</text>
      <rect x="80" y="40" width="40" height="40" fill="#1c2333" stroke="#30363d" stroke-width="0.5"/><text x="100" y="65" text-anchor="middle" fill="#6b7280" font-size="11">70</text>
      <rect x="0" y="80" width="40" height="40" fill="#1c2333" stroke="#30363d" stroke-width="0.5"/><text x="20" y="105" text-anchor="middle" fill="#6b7280" font-size="11">40</text>
      <rect x="40" y="80" width="40" height="40" fill="#1c2333" stroke="#30363d" stroke-width="0.5"/><text x="60" y="105" text-anchor="middle" fill="#6b7280" font-size="11">100</text>
      <rect x="80" y="80" width="40" height="40" fill="#1c2333" stroke="#30363d" stroke-width="0.5"/><text x="100" y="105" text-anchor="middle" fill="#6b7280" font-size="11">55</text>
    </g>

    <!-- × sign -->
    <text x="180" y="120" fill="#8b949e" font-size="20" font-weight="700">×</text>

    <!-- Kernel grid -->
    <g transform="translate(210, 45)">
      <text x="60" y="-5" text-anchor="middle" fill="#8b949e" font-size="9">Kernel (Edge Detection)</text>
      <rect x="0" y="0" width="40" height="40" fill="#3b1f1f" stroke="#ef4444" stroke-width="0.5"/><text x="20" y="25" text-anchor="middle" fill="#fca5a5" font-size="11">-1</text>
      <rect x="40" y="0" width="40" height="40" fill="#3b1f1f" stroke="#ef4444" stroke-width="0.5"/><text x="60" y="25" text-anchor="middle" fill="#fca5a5" font-size="11">-1</text>
      <rect x="80" y="0" width="40" height="40" fill="#3b1f1f" stroke="#ef4444" stroke-width="0.5"/><text x="100" y="25" text-anchor="middle" fill="#fca5a5" font-size="11">-1</text>
      <rect x="0" y="40" width="40" height="40" fill="#3b1f1f" stroke="#ef4444" stroke-width="0.5"/><text x="20" y="65" text-anchor="middle" fill="#fca5a5" font-size="11">-1</text>
      <rect x="40" y="40" width="40" height="40" fill="#1f3b1f" stroke="#22c55e" stroke-width="1.5"/><text x="60" y="65" text-anchor="middle" fill="#86efac" font-size="11" font-weight="700">8</text>
      <rect x="80" y="40" width="40" height="40" fill="#3b1f1f" stroke="#ef4444" stroke-width="0.5"/><text x="100" y="65" text-anchor="middle" fill="#fca5a5" font-size="11">-1</text>
      <rect x="0" y="80" width="40" height="40" fill="#3b1f1f" stroke="#ef4444" stroke-width="0.5"/><text x="20" y="105" text-anchor="middle" fill="#fca5a5" font-size="11">-1</text>
      <rect x="40" y="80" width="40" height="40" fill="#3b1f1f" stroke="#ef4444" stroke-width="0.5"/><text x="60" y="105" text-anchor="middle" fill="#fca5a5" font-size="11">-1</text>
      <rect x="80" y="80" width="40" height="40" fill="#3b1f1f" stroke="#ef4444" stroke-width="0.5"/><text x="100" y="105" text-anchor="middle" fill="#fca5a5" font-size="11">-1</text>
    </g>

    <!-- = sign -->
    <text x="360" y="120" fill="#8b949e" font-size="20" font-weight="700">=</text>

    <!-- Result -->
    <g transform="translate(390, 70)">
      <rect width="120" height="75" rx="6" fill="#161b22" stroke="#30363d" stroke-width="1"/>
      <text x="60" y="20" text-anchor="middle" fill="#8b949e" font-size="9">Output pixel</text>
      <text x="60" y="45" text-anchor="middle" fill="#a78bfa" font-size="9" font-family="monospace">(-50-80-60-90</text>
      <text x="60" y="57" text-anchor="middle" fill="#a78bfa" font-size="9" font-family="monospace">+960-70-40</text>
      <text x="60" y="69" text-anchor="middle" fill="#a78bfa" font-size="9" font-family="monospace">-100-55) = 415</text>
    </g>

    <!-- Process description -->
    <rect x="30" y="170" width="485" height="65" rx="4" fill="#161b22" stroke="#30363d" stroke-width="1"/>
    <text x="50" y="190" fill="#c9d1d9" font-size="10">For each pixel: center the kernel, multiply neighbors by weights, sum.</text>
    <text x="50" y="205" fill="#c9d1d9" font-size="10">Result is clamped to [0, 255] for 8bipp output.</text>
    <text x="50" y="220" fill="#8b949e" font-size="9">Kernel slides across the entire image → produces a new Pixel_Buffer</text>
  </g>

  <!-- === Predefined Kernels === -->
  <g transform="translate(590, 55)">
    <rect width="280" height="250" rx="8" fill="#1a1a2e" filter="url(#ks)" stroke="#30363d" stroke-width="1"/>
    <text x="140" y="22" text-anchor="middle" fill="#22c55e" font-size="13" font-weight="700">Predefined Kernels</text>

    <!-- Edge -->
    <g transform="translate(15, 38)">
      <text x="0" y="12" fill="#86efac" font-size="10" font-weight="600">edge</text><text x="50" y="12" fill="#8b949e" font-size="8">3×3 Float32Array</text>
      <g transform="translate(0, 18)">
        <rect width="24" height="16" rx="2" fill="#3b1f1f"/><text x="12" y="12" text-anchor="middle" fill="#fca5a5" font-size="7">-1</text>
        <rect x="26" width="24" height="16" rx="2" fill="#3b1f1f"/><text x="38" y="12" text-anchor="middle" fill="#fca5a5" font-size="7">-1</text>
        <rect x="52" width="24" height="16" rx="2" fill="#3b1f1f"/><text x="64" y="12" text-anchor="middle" fill="#fca5a5" font-size="7">-1</text>
        <rect x="78" width="24" height="16" rx="2" fill="#3b1f1f"/><text x="90" y="12" text-anchor="middle" fill="#fca5a5" font-size="7">-1</text>
        <rect x="104" width="24" height="16" rx="2" fill="#1f3b1f"/><text x="116" y="12" text-anchor="middle" fill="#86efac" font-size="7" font-weight="700">8</text>
        <rect x="130" width="24" height="16" rx="2" fill="#3b1f1f"/><text x="142" y="12" text-anchor="middle" fill="#fca5a5" font-size="7">-1</text>
        <rect x="156" width="24" height="16" rx="2" fill="#3b1f1f"/><text x="168" y="12" text-anchor="middle" fill="#fca5a5" font-size="7">-1</text>
        <rect x="182" width="24" height="16" rx="2" fill="#3b1f1f"/><text x="194" y="12" text-anchor="middle" fill="#fca5a5" font-size="7">-1</text>
        <rect x="208" width="24" height="16" rx="2" fill="#3b1f1f"/><text x="220" y="12" text-anchor="middle" fill="#fca5a5" font-size="7">-1</text>
      </g>
    </g>

    <!-- Sobel X -->
    <g transform="translate(15, 90)">
      <text x="0" y="12" fill="#7dd3fc" font-size="10" font-weight="600">sobel_x</text><text x="60" y="12" fill="#8b949e" font-size="8">3×3 Int8Array</text>
      <g transform="translate(0, 18)">
        <rect width="24" height="16" rx="2" fill="#3b1f1f"/><text x="12" y="12" text-anchor="middle" fill="#fca5a5" font-size="7">-1</text>
        <rect x="26" width="24" height="16" rx="2" fill="#1c2333"/><text x="38" y="12" text-anchor="middle" fill="#6b7280" font-size="7">0</text>
        <rect x="52" width="24" height="16" rx="2" fill="#1f3b1f"/><text x="64" y="12" text-anchor="middle" fill="#86efac" font-size="7">1</text>
        <rect x="78" width="24" height="16" rx="2" fill="#3b1f1f"/><text x="90" y="12" text-anchor="middle" fill="#fca5a5" font-size="7">-2</text>
        <rect x="104" width="24" height="16" rx="2" fill="#1c2333"/><text x="116" y="12" text-anchor="middle" fill="#6b7280" font-size="7">0</text>
        <rect x="130" width="24" height="16" rx="2" fill="#1f3b1f"/><text x="142" y="12" text-anchor="middle" fill="#86efac" font-size="7">2</text>
        <rect x="156" width="24" height="16" rx="2" fill="#3b1f1f"/><text x="168" y="12" text-anchor="middle" fill="#fca5a5" font-size="7">-1</text>
        <rect x="182" width="24" height="16" rx="2" fill="#1c2333"/><text x="194" y="12" text-anchor="middle" fill="#6b7280" font-size="7">0</text>
        <rect x="208" width="24" height="16" rx="2" fill="#1f3b1f"/><text x="220" y="12" text-anchor="middle" fill="#86efac" font-size="7">1</text>
      </g>
    </g>

    <!-- Sobel Y -->
    <g transform="translate(15, 142)">
      <text x="0" y="12" fill="#fbbf24" font-size="10" font-weight="600">sobel_y</text><text x="60" y="12" fill="#8b949e" font-size="8">3×3 Int8Array</text>
      <g transform="translate(0, 18)">
        <rect width="24" height="16" rx="2" fill="#3b1f1f"/><text x="12" y="12" text-anchor="middle" fill="#fca5a5" font-size="7">-1</text>
        <rect x="26" width="24" height="16" rx="2" fill="#3b1f1f"/><text x="38" y="12" text-anchor="middle" fill="#fca5a5" font-size="7">-2</text>
        <rect x="52" width="24" height="16" rx="2" fill="#3b1f1f"/><text x="64" y="12" text-anchor="middle" fill="#fca5a5" font-size="7">-1</text>
        <rect x="78" width="24" height="16" rx="2" fill="#1c2333"/><text x="90" y="12" text-anchor="middle" fill="#6b7280" font-size="7">0</text>
        <rect x="104" width="24" height="16" rx="2" fill="#1c2333"/><text x="116" y="12" text-anchor="middle" fill="#6b7280" font-size="7">0</text>
        <rect x="130" width="24" height="16" rx="2" fill="#1c2333"/><text x="142" y="12" text-anchor="middle" fill="#6b7280" font-size="7">0</text>
        <rect x="156" width="24" height="16" rx="2" fill="#1f3b1f"/><text x="168" y="12" text-anchor="middle" fill="#86efac" font-size="7">1</text>
        <rect x="182" width="24" height="16" rx="2" fill="#1f3b1f"/><text x="194" y="12" text-anchor="middle" fill="#86efac" font-size="7">2</text>
        <rect x="208" width="24" height="16" rx="2" fill="#1f3b1f"/><text x="220" y="12" text-anchor="middle" fill="#86efac" font-size="7">1</text>
      </g>
    </g>

    <!-- Gaussian -->
    <g transform="translate(15, 198)">
      <text x="0" y="12" fill="#f472b6" font-size="10" font-weight="600">gauss_blur_5_2</text><text x="100" y="12" fill="#8b949e" font-size="8">5×5 generated</text>
      <rect x="0" y="18" width="248" height="28" rx="4" fill="#161b22" stroke="#30363d" stroke-width="1"/>
      <text x="124" y="36" text-anchor="middle" fill="#f9a8d4" font-size="8" font-family="monospace">generateGaussianKernel(5, 2)</text>
    </g>
  </g>

  <!-- === Convolution Pipeline === -->
  <g transform="translate(30, 330)">
    <rect width="840" height="100" rx="8" fill="#1a1a2e" filter="url(#ks)" stroke="#30363d" stroke-width="1"/>
    <text x="420" y="22" text-anchor="middle" fill="#0ea5e9" font-size="13" font-weight="700">Convolution Pipeline</text>

    <!-- Pipeline boxes -->
    <g transform="translate(30, 38)">
      <rect width="130" height="46" rx="6" fill="#1f2937" stroke="#4b5563" stroke-width="1"/>
      <text x="65" y="20" text-anchor="middle" fill="#e2e8f0" font-size="10" font-weight="600">Source Buffer</text>
      <text x="65" y="34" text-anchor="middle" fill="#6b7280" font-size="8">8bipp Pixel_Buffer</text>
    </g>
    <text x="192" y="67" fill="#484f58" font-size="16">→</text>
    <g transform="translate(210, 38)">
      <rect width="130" height="46" rx="6" fill="#312e81" stroke="#6366f1" stroke-width="1"/>
      <text x="65" y="20" text-anchor="middle" fill="#c7d2fe" font-size="10" font-weight="600">Float32Convolution</text>
      <text x="65" y="34" text-anchor="middle" fill="#818cf8" font-size="8">kernel + size</text>
    </g>
    <text x="372" y="67" fill="#484f58" font-size="16">→</text>
    <g transform="translate(390, 38)">
      <rect width="130" height="46" rx="6" fill="#14532d" stroke="#22c55e" stroke-width="1"/>
      <text x="65" y="20" text-anchor="middle" fill="#bbf7d0" font-size="10" font-weight="600">new_convolved()</text>
      <text x="65" y="34" text-anchor="middle" fill="#4ade80" font-size="8">slide + multiply + sum</text>
    </g>
    <text x="552" y="67" fill="#484f58" font-size="16">→</text>
    <g transform="translate(570, 38)">
      <rect width="130" height="46" rx="6" fill="#1f2937" stroke="#4b5563" stroke-width="1"/>
      <text x="65" y="20" text-anchor="middle" fill="#e2e8f0" font-size="10" font-weight="600">Result Buffer</text>
      <text x="65" y="34" text-anchor="middle" fill="#6b7280" font-size="8">New 8bipp Pixel_Buffer</text>
    </g>
    <g transform="translate(720, 38)">
      <text x="0" y="20" fill="#8b949e" font-size="9">Input is</text>
      <text x="0" y="32" fill="#8b949e" font-size="9">unchanged</text>
    </g>
  </g>

  <!-- === Two API Paths === -->
  <g transform="translate(30, 455)">
    <rect width="400" height="130" rx="8" fill="#1a1a2e" filter="url(#ks)" stroke="#30363d" stroke-width="1"/>
    <text x="200" y="22" text-anchor="middle" fill="#f97316" font-size="12" font-weight="700">API Path 1: new_convolved()</text>

    <rect x="15" y="35" width="370" height="80" rx="4" fill="#161b22" stroke="#30363d" stroke-width="1"/>
    <text x="25" y="53" fill="#8b949e" font-size="9" font-family="monospace">const Float32Conv =</text>
    <text x="25" y="66" fill="#f97316" font-size="9" font-family="monospace">  require('jsgui3-gfx-core/core/convolution');</text>
    <text x="25" y="82" fill="#8b949e" font-size="9" font-family="monospace">const conv = new Float32Conv({</text>
    <text x="25" y="95" fill="#8b949e" font-size="9" font-family="monospace">  size:[3,3], value:[0,-1,0,-1,5,-1,0,-1,0]});</text>
    <text x="25" y="108" fill="#f97316" font-size="9" font-family="monospace">const result = pb.new_convolved(conv);</text>
  </g>

  <g transform="translate(470, 455)">
    <rect width="400" height="130" rx="8" fill="#1a1a2e" filter="url(#ks)" stroke="#30363d" stroke-width="1"/>
    <text x="200" y="22" text-anchor="middle" fill="#14b8a6" font-size="12" font-weight="700">API Path 2: apply_square_convolution()</text>

    <rect x="15" y="35" width="370" height="80" rx="4" fill="#161b22" stroke="#30363d" stroke-width="1"/>
    <text x="25" y="53" fill="#8b949e" font-size="9" font-family="monospace">const {convolution_kernels} =</text>
    <text x="25" y="66" fill="#14b8a6" font-size="9" font-family="monospace">  require('jsgui3-gfx-core');</text>
    <text x="25" y="82" fill="#8b949e" font-size="9" font-family="monospace">const edges =</text>
    <text x="25" y="95" fill="#14b8a6" font-size="9" font-family="monospace">  pb.apply_square_convolution(</text>
    <text x="25" y="108" fill="#14b8a6" font-size="9" font-family="monospace">    new Float32Array(kernels.edge));</text>
  </g>
</svg>
